#!/bin/sh

set -e

BOOTSTRAP_DIR=/var/lib/appliance-setup
BOOTSTRAP_STAMP_FILE=$BOOTSTRAP_DIR/bootstrap-stamp
VERSION_FILE=/etc/appliance-setup-version
: ${APPLIANCE_COMPONENTS:="kenyaemr"}

usage()
{
cat <<EOF >&2
usage: $0 <command>

Commands
apply:   configure the appliance
help:    display usage information
update:  fetch the latest version of the appliance-setup repository
version: display repository version
EOF
}

bootstrap()
{
	if [ ! -d "$BOOTSTRAP_DIR" ]; then
		mkdir -p "$BOOTSTRAP_DIR"
	fi

	if [ ! -f "$BOOTSTRAP_STAMP_FILE" ]; then
		cat <<EOF >/etc/apt/sources.list.d/puppetlabs.list
deb http://apt.puppetlabs.com/ squeeze main
deb-src http://apt.puppetlabs.com/ squeeze main
EOF

		apt-key adv --keyserver keyserver.ubuntu.com --recv 4BD6EC30
		apt-get update

		# Install the latest version of Puppet
		apt-get -y install facter puppet pwgen

		# Create local configuration file

		# Ensure file exists and has restrictive permissions
		touch puppet/etc/hieradb/local.yaml
		chmod 600 puppet/etc/hieradb/local.yaml

		# Add commented out default configuration if local file is empty
		if [ ! -s puppet/etc/hieradb/local.yaml ]; then
			sed 's/^/#/' puppet/etc/hieradb/common.yaml > puppet/etc/hieradb/local.yaml

			# Add components to local configuration
			echo "classes:" >> puppet/etc/hieradb/local.yaml
			for s in $APPLIANCE_COMPONENTS; do
				echo " - appliance_components::$s" >> puppet/etc/hieradb/local.yaml
			done

			# Generate random mysql root password
			echo "mysql_root_password: $(pwgen -s 10)" >> puppet/etc/hieradb/local.yaml
		fi
	fi

	date > "$BOOTSTRAP_STAMP_FILE"
}

run_hiera()
{
	cd puppet
	hiera --config etc/hiera.yaml "$@"
}

run_puppet()
{
	if [ $# -eq 0 ]; then
		echo "Command is required"
		exit 1
	fi

	command=$1
	shift

	cd puppet
	puppet $command --confdir etc "$@"
}

run_puppet_apply()
{
	run_puppet apply site.pp
}

print_version()
{
	git describe --dirty
}

script_base_dir=$(cd "$(dirname "$0")"/.. && pwd)
cd "$script_base_dir"

if [ -n "$1" ]; then
	command=$1
	shift
else
	command=help
fi

case "$command" in
apply)
	bootstrap
	run_puppet_apply
	print_version > "$VERSION_FILE"
	;;
bootstrap)
	# Force a bootstrap
	rm -f "$BOOTSTRAP_STAMP_FILE"
	bootstrap
	;;
help)
	usage
	;;
hiera)
	run_hiera "$@"
	;;
puppet)
	run_puppet "$@"
	;;
update)
	git fetch
	git reset --hard @{u}
	git submodule update --init
	;;
version)
	print_version
	;;
*)
	echo "Invalid command: $command"
esac
