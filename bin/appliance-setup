#!/bin/sh

set -e

usage()
{
cat <<EOF >&2
usage: $0 <command>

Commands
apply:   configure the appliance
help:    display usage information
update:  fetch the latest version of the appliance-setup repository
version: display repository version
EOF
}

install_puppet()
{
	if ! dpkg-query -W --showformat='${Status}\n' puppet 2>/dev/null | grep -q "install ok installed"; then
		cat <<EOF >/etc/apt/sources.list.d/puppet.list
deb http://apt.puppetlabs.com/ lucid main
deb-src http://apt.puppetlabs.com/ lucid main
EOF

		apt-key adv --keyserver keyserver.ubuntu.com --recv 4BD6EC30
		apt-get update

		apt-get -y install puppet
	fi
}

run_puppet_apply()
{
	cd puppet
	puppet apply --modulepath=modules --color=false site.pp "$@"
}

print_version()
{
	git describe --dirty --long --always
}


script_base_dir=$(cd "$(dirname "$0")"/.. && pwd)
cd "$script_base_dir"

if [ -n "$1" ]; then
        command=$1
	shift
else
        command=apply
fi

case "$command" in
apply)
	install_puppet
	run_puppet_apply
	print_version > /etc/appliance-setup-version
	;;
help)
	usage
	;;
puppet)
	run_puppet_apply "$@"
	;;
update)
	git fetch
	git reset --hard @{u}
	git submodule update --init
	;;
version)
	print_version
	;;
*)
	echo "Invalid command: $command"
esac
